package login;

import android.os.Bundle;
import android.os.Looper;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;

import com.example.hsdj.MyApplication;
import com.example.hsdj.R;
import com.google.gson.Gson;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

import okhttp3.Call;
import okhttp3.Callback;
import okhttp3.FormBody;
import okhttp3.MediaType;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.RequestBody;
import okhttp3.Response;

public class LoginActivity extends AppCompatActivity {
    Button button1; //点击的LinearLayout
    private EditText et_data_uname;
    private EditText et_data_upass;
    private Map<String, String> stringHashMap = new HashMap<String, String>();
    private String username;
    private String token;

    public static final MediaType JSON = MediaType.parse("application/json; charset=utf-8");

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_login);
        MyApplication myApplication= (MyApplication) getApplication();

        button1= findViewById(R.id.button1);
        /*用户登录验证接口*/
        button1.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                et_data_uname = (EditText) findViewById(R.id.et_data_uname);
                et_data_upass = (EditText) findViewById(R.id.et_data_upass);
                //创建OkHttpClient实例，主要用于请求网络
                OkHttpClient okHttpClient = new OkHttpClient();
                //创建表单请求体
                FormBody.Builder formBody = new FormBody.Builder();
                //传递键值对参数
                formBody.add("username",et_data_uname.getText().toString());
                formBody.add("userpwd",et_data_upass.getText().toString());
                //创建Request实例，设置POST参数
                Request okRequest = new Request.Builder().url("http://192.168.9.116:8001/app/hsdj/authmgr/views/userLogin").post(formBody.build()).build();
                //POST异步请求，回调函数中获取相应结果
                okHttpClient.newCall(okRequest).enqueue(new Callback() {
                    @Override
                    public void onFailure(Call call, IOException e) {
                        Looper.prepare();
                        Toast.makeText(getApplication(), "登录失败！", Toast.LENGTH_SHORT).show();
                        Looper.loop();
                    }
                    @Override
                    public void onResponse(Call call, Response response) throws IOException {
                        Looper.prepare();
                        try {
                            JSONObject jsonObject=new JSONObject(response.body().string());
                            if("OK".equalsIgnoreCase(jsonObject.optString("message"))){
                                Toast.makeText(getApplication(), "登录成功！", Toast.LENGTH_SHORT).show();
                                JSONObject data=new JSONObject(jsonObject.optString("data"));
                                token=data.optString("token");

                                //用户信息接口：同步post请求
                                BusinessJson businessJson=new BusinessJson();
                                businessJson.setUsername(et_data_uname.getText().toString());
                                ControlJson controlJson=new ControlJson();
                                controlJson.setMenuId(0);controlJson.setToken(token);controlJson.setOpt_desc("移动端登录");
                                String json="{\"businessJson\":{\"username\":\""+et_data_uname.getText().toString()+"\"},\"controlJson\":{\"menuId\":0,\"token\":\""+token+"\",\"opt_desc\":\"移动端登录\"}}";
//                                Log.d("json",json);
                                RequestBody body = RequestBody.create(JSON, json);
                                Request request = new Request.Builder()
                                        .url("http://192.168.9.116:8001/app/hsdj/authmgr/views/getUsers")
                                        .post(body)
                                        .build();
                                OkHttpClient client = new OkHttpClient();
                                Response response1 = client.newCall(request).execute();
                                if (response1.isSuccessful()) {
                                    Gson gson=new Gson();
                                    UserInfo userInfo = gson.fromJson(response1.body().string(), UserInfo.class);
                                    myApplication.setUsername(userInfo.getData().getRows().get(0).getUsername());
                                    myApplication.setUserId(String.valueOf(userInfo.getData().getRows().get(0).getId()));
                                    myApplication.setUserdesc(userInfo.getData().getRows().get(0).getUserdesc());
                                    finish();
                                } else {
                                    throw new IOException("Unexpected code " + response1);
                                }
                            }else{
                                Toast.makeText(getApplication(), "用户名或密码错误！", Toast.LENGTH_SHORT).show();
                            }
                        } catch (JSONException e) {
                            e.printStackTrace();
                        }
                        Looper.loop();
                    }
                });
            }
        });
    }

    class BusinessJson{
        String username;

        public String getUsername() {
            return username;
        }

        public void setUsername(String username) {
            this.username = username;
        }

        @Override
        public String toString() {
            return "businessJson"+":{" +
                    "username:'" + username + '\'' +
                    '}';
        }
    }

    class ControlJson{
       private int menuId;
       private String token;
       private String opt_desc;

        public int getMenuId() {
            return menuId;
        }

        public void setMenuId(int menuId) {
            this.menuId = menuId;
        }

        public String getToken() {
            return token;
        }

        public void setToken(String token) {
            this.token = token;
        }

        public String getOpt_desc() {
            return opt_desc;
        }

        public void setOpt_desc(String opt_desc) {
            this.opt_desc = opt_desc;
        }

        @Override
        public String toString() {
            return "'controlJson'"+":{" +
                    "menuId:" + menuId +
                    ", token:'" + token + '\'' +
                    ", opt_desc:'" + opt_desc + '\'' +
                    '}';
        }
    }
}